<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Activity Schedule ‚Äî Admin Dashboard</title>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>

  <style>
    * { box-sizing: border-box; font-family: 'Poppins', sans-serif; }
    body { background: #f6f9fc; margin: 0; padding: 0; color: #333; }

    header {
      background: linear-gradient(135deg, #006666, #009999);
      color: white;
      text-align: center;
      padding: 15px 20px;
      font-size: 22px;
      font-weight: 600;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    main {
      max-width: 950px;
      margin: 20px auto;
      background: white;
      padding: 25px 30px;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.05);
    }

    h2 { margin-bottom: 15px; color: #006666; font-weight: 600; }

    label { display: block; margin-top: 12px; font-weight: 500; }

    input, select {
      width: 100%;
      padding: 10px;
      margin-top: 6px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 15px;
    }

    .days-container {
      display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px;
    }
    .day {
      background: #eaf5f5; border-radius: 20px; padding: 6px 12px;
      border: 1px solid #009999; cursor: pointer; transition: 0.3s;
    }
    .day.active { background: #009999; color: white; }

    button {
      background: #006666; color: white; border: none; border-radius: 6px;
      padding: 10px 18px; font-size: 16px; margin-top: 15px; cursor: pointer;
      transition: background 0.3s ease;
    }
    button:hover { background: #009999; }

    .schedule-list { margin-top: 35px; }

    table {
      width: 100%; border-collapse: collapse; margin-top: 15px;
    }
    th, td {
      padding: 10px 12px; border-bottom: 1px solid #eee; text-align: left;
    }
    th {
      background: #006666; color: white; text-transform: uppercase; font-size: 13px;
    }
    tr:nth-child(even) { background: #f9f9f9; }
    .no-data { text-align: center; padding: 15px; color: #777; }

    .actions button {
      padding: 5px 10px; font-size: 13px; border-radius: 4px; margin: 0 3px;
    }
    .edit-btn { background: #ffb74d; color: #fff; }
    .delete-btn { background: #e57373; color: #fff; }

    @media (max-width: 768px) {
      main { padding: 15px; }
      button { width: 100%; }
      th, td { font-size: 13px; }
    }
  </style>
</head>
<body>
  <header>üóìÔ∏è Schedule Activity ‚Äî Admin Panel</header>

  <main>
    <h2>Create / Edit Schedule</h2>
    <form id="scheduleForm">
      <label>Department:</label>
      <div style="display:flex; gap:10px;">
        <select id="department" required style="flex:1;">
          <option value="">Select Department</option>
        </select>
        <button type="button" id="addDeptBtn" style="background:#009999;">+ Add</button>
      </div>

      <label>Activity Name:</label>
      <input type="text" id="activityName" placeholder="e.g. Dustbin Cleaning" required />

      <label>Frequency:</label>
      <select id="frequency" required>
        <option value="">Select Frequency</option>
        <option value="Daily">Daily</option>
        <option value="Weekly">Weekly</option>
        <option value="Monthly">Monthly</option>
        <option value="Quarterly">Quarterly</option>
      </select>

      <div id="daysSection">
        <label>Recurring Days:</label>
        <div class="days-container" id="daysContainer">
          <div class="day">Monday</div>
          <div class="day">Tuesday</div>
          <div class="day">Wednesday</div>
          <div class="day">Thursday</div>
          <div class="day">Friday</div>
          <div class="day">Saturday</div>
          <div class="day">Sunday</div>
        </div>
      </div>

      <label>Next Scheduled Date (for Monthly/Quarterly):</label>
      <input type="date" id="nextDate" />

      <label><input type="checkbox" id="isRecurring" /> Recurring Activity</label>

      <button type="submit" id="saveBtn">Save Schedule</button>
    </form>

    <div class="schedule-list">
      <h2>üìã Existing Schedules</h2>

      <label>Filter by Department:</label>
      <select id="filterDept">
        <option value="All">All Departments</option>
      </select>

      <table>
        <thead>
          <tr>
            <th>Department</th>
            <th>Activity</th>
            <th>Frequency</th>
            <th>Days</th>
            <th>Next Date</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="scheduleTableBody">
          <tr><td colspan="6" class="no-data">Loading...</td></tr>
        </tbody>
      </table>
    </div>
  </main>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCS98TwN_CqGLuS1a600P76La7I7t6kJqU",
      authDomain: "facilitymanagement-47470.firebaseapp.com",
      projectId: "facilitymanagement-47470",
      storageBucket: "facilitymanagement-47470.firebasestorage.app",
      messagingSenderId: "638809761503",
      appId: "1:638809761503:web:1a15443eeeee2414aaab6a",
    };
    if (!window.firebaseAppsInitialized) {
      firebase.initializeApp(firebaseConfig);
      window.firebaseAppsInitialized = true;
    }
    const db = firebase.firestore();

    const form = document.getElementById("scheduleForm");
    const deptSelect = document.getElementById("department");
    const addDeptBtn = document.getElementById("addDeptBtn");
    const daysContainer = document.getElementById("daysContainer");
    const tableBody = document.getElementById("scheduleTableBody");
    const filterDept = document.getElementById("filterDept");
    const saveBtn = document.getElementById("saveBtn");

    let editId = null;

    // --- Default departments so UI isn't empty if Firestore is missing some ---
    const defaultDepartments = ["M&E", "H&K", "Security", "EHS"];

    // ---------------- Load Departments (hybrid: defaults + firestore) ----------------
    async function loadDepartments() {
      // add defaults first
      defaultDepartments.forEach(addDeptOption);

      try {
        const snapshot = await db.collection("departments").get();
        snapshot.forEach(doc => {
          const d = doc.data();
          if (d && d.name) addDeptOption(d.name.trim());
        });
      } catch (err) {
        console.error("Error loading departments:", err);
        // still continue with defaults
      }
    }

    function addDeptOption(name) {
      if (!name) return;
      // department select
      if (![...deptSelect.options].some(o => o.value === name)) {
        const opt = new Option(name, name);
        deptSelect.add(opt);
      }
      // filter select (keep "All" as first)
      if (![...filterDept.options].some(o => o.value === name)) {
        const opt2 = new Option(name, name);
        filterDept.add(opt2);
      }
    }

    // Add Department (writes to firestore + updates UI)
    addDeptBtn.addEventListener("click", async () => {
      const newDept = prompt("Enter new department name:");
      if (!newDept) return;
      const trimmed = newDept.trim();
      try {
        await db.collection("departments").add({ name: trimmed });
        addDeptOption(trimmed);
        deptSelect.value = trimmed;
        alert("‚úÖ Department added successfully!");
      } catch (err) {
        console.error("Error adding department:", err);
        alert("‚ùå Could not add department (check console).");
      }
    });

    // Toggle day selection
    daysContainer.addEventListener("click", e => {
      if (e.target.classList.contains("day")) e.target.classList.toggle("active");
    });

    // Save or Update Schedule
    form.addEventListener("submit", async e => {
      e.preventDefault();
      try {
        const data = {
          department: deptSelect.value,
          activityName: document.getElementById("activityName").value.trim(),
          frequency: document.getElementById("frequency").value,
          isRecurring: document.getElementById("isRecurring").checked,
          nextDate: document.getElementById("nextDate").value || null,
          recurringDays: [...document.querySelectorAll(".day.active")].map(d => d.textContent),
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        };

        if (!data.department) {
          alert("Please select a department.");
          return;
        }
        if (!data.activityName) {
          alert("Please enter an activity name.");
          return;
        }

        if (editId) {
          await db.collection("activitySchedules").doc(editId).update(data);
          alert("‚úÖ Schedule updated successfully!");
          editId = null;
          saveBtn.textContent = "Save Schedule";
        } else {
          await db.collection("activitySchedules").add(data);
          alert("‚úÖ Schedule created successfully!");
        }

        form.reset();
        document.querySelectorAll(".day.active").forEach(d => d.classList.remove("active"));
      } catch (err) {
        console.error(err);
        alert("‚ùå Error saving schedule");
      }
    });

    // ---------------- Realtime schedules listener + client-side filter ----------------
    let unsubscribe = null;
    let allSchedulesCache = [];

    function startListeningSchedules() {
      if (unsubscribe) unsubscribe();

      const ref = db.collection("activitySchedules").orderBy("createdAt", "desc");

      unsubscribe = ref.onSnapshot(snapshot => {
        allSchedulesCache = [];
        if (snapshot.empty) {
          tableBody.innerHTML = `<tr><td colspan="6" class="no-data">No schedules found</td></tr>`;
          return;
        }
        snapshot.forEach(doc => {
          const item = { id: doc.id, ...doc.data() };
          allSchedulesCache.push(item);
        });

        // render with current filter
        const current = filterDept.value || "All";
        renderSchedules(current);
      }, error => {
        console.error("Firestore snapshot error:", error);
        tableBody.innerHTML = `<tr><td colspan="6" class="no-data">Error loading schedules. See console for details.</td></tr>`;
      });
    }

    function renderSchedules(deptFilter = "All") {
      tableBody.innerHTML = "";
      const toRender = deptFilter === "All"
        ? allSchedulesCache
        : allSchedulesCache.filter(s => (s.department || "").trim() === deptFilter);

      if (!toRender.length) {
        tableBody.innerHTML = `<tr><td colspan="6" class="no-data">No schedules found</td></tr>`;
        return;
      }

      toRender.forEach(s => renderRow(s.id, s));
    }

    // Render Table Row
    function renderRow(id, s) {
      const days = (s.recurringDays || []).join(", ") || "-";
      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${escapeHtml(s.department || "-")}</td>
        <td>${escapeHtml(s.activityName || "-")}</td>
        <td>${escapeHtml(s.frequency || "-")}</td>
        <td>${escapeHtml(days)}</td>
        <td>${escapeHtml(s.nextDate || "-")}</td>
        <td class="actions">
          <button class="edit-btn" data-id="${id}">Edit</button>
          <button class="delete-btn" data-id="${id}">Delete</button>
        </td>`;
      tableBody.appendChild(row);
    }

    // Filter dropdown change -> client-side render
    filterDept.addEventListener("change", () => {
      renderSchedules(filterDept.value || "All");
    });

    // Edit / Delete Actions
    tableBody.addEventListener("click", async e => {
      const id = e.target.dataset.id;
      if (!id) return;

      if (e.target.classList.contains("edit-btn")) {
        try {
          const docSnap = await db.collection("activitySchedules").doc(id).get();
          const s = docSnap.data();
          if (!s) { alert("Record not found"); return; }
          deptSelect.value = s.department || "";
          document.getElementById("activityName").value = s.activityName || "";
          document.getElementById("frequency").value = s.frequency || "";
          document.getElementById("isRecurring").checked = !!s.isRecurring;
          document.getElementById("nextDate").value = s.nextDate || "";
          document.querySelectorAll(".day").forEach(d => {
            d.classList.toggle("active", (s.recurringDays || []).includes(d.textContent));
          });
          editId = id;
          saveBtn.textContent = "Update Schedule";
          window.scrollTo({ top: 0, behavior: "smooth" });
        } catch (err) {
          console.error("Error fetching schedule for edit:", err);
          alert("‚ùå Could not load schedule for edit");
        }
      }

      if (e.target.classList.contains("delete-btn")) {
        if (!confirm("Are you sure you want to delete this schedule?")) return;
        try {
          await db.collection("activitySchedules").doc(id).delete();
          alert("üóëÔ∏è Schedule deleted successfully!");
        } catch (err) {
          console.error("Delete error:", err);
          alert("‚ùå Could not delete schedule");
        }
      }
    });

    // small helper to prevent XSS when injecting strings into table
    function escapeHtml(str) {
      return String(str)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    // Init
    loadDepartments().then(() => {
      // ensure "All" is selected
      filterDept.value = "All";
      startListeningSchedules();
    });
  </script>
</body>
</html>